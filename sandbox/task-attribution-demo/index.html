<!DOCTYPE html>
<html>
<head>
    <title>Task Attribution demo</title>
</head>
<body>
    <button>Click Me</button>

    <script>
function block(ms) {
    const start = performance.now();
    while (performance.now() - start < ms) {
        // Busy wait
    }
}

document.querySelector('button').addEventListener('click', async () => {
    block(51);
    await fetch('index.html');
    block(51);
    await scheduler.yield();
    block(51);
    await new Promise(resolve => setTimeout(resolve, 100));
    block(51);

    // Update the URL
    history.pushState({}, '', `?rand=${Math.random().toString(36).substring(2, 15)}`);

    // Add some text to the document body
    const text = "Lorem Ipsum";
    const t = document.createTextNode(text);
    const d = document.createElement('div');
    d.appendChild(t);
    document.body.appendChild(d);
});
    </script>

    <script>

const events = [];
function getEventTimingForSoftNavEntry(navEntry) {
    const eventTimingEntry = events.find(event =>
        event.processingStart <= navEntry.startTime && event.processingEnd >= navEntry.startTime
    );
    return eventTimingEntry;
}

function getSoftNavEntryForICPEntry(icpEntry) {
    const navEntry = performance.getEntriesByType('soft-navigation')
        .find(nav => nav.navigationId === icpEntry.navigationId);
    return navEntry;
}

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        if (entry.interactionId) {
            events.push(entry);
            performance.measure('InteractionToNextPaint', { start: entry.startTime, duration: entry.duration });
        }
    }
}).observe({ type: 'event', durationThreshold: 0, buffered: true });

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        performance.measure('LoAF', { start: entry.startTime, duration: entry.duration });
    }
}).observe({ type: 'long-animation-frame', buffered: true });

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        performance.measure('SoftNav', { start: entry.startTime, duration: entry.duration });
    }
}).observe({ type: 'soft-navigation', buffered: true });


new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        const navEntry = getSoftNavEntryForICPEntry(entry);
        const eventTimingEntry = getEventTimingForSoftNavEntry(navEntry);

        performance.measure('Soft.LCP', { start: navEntry.startTime, end: entry.startTime });
        
        if (eventTimingEntry) {
            performance.measure(
                'InteractionToContentfulPaint',
                { start: eventTimingEntry.startTime, end: entry.startTime }
            );
        }


    }
}).observe({ type: 'interaction-contentful-paint', buffered: true });

    </script>
</body>
</html>
