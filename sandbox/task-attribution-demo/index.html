<!DOCTYPE html>
<html>
<head>
    <title>Task Attribution demo</title>
</head>
<body>
    <button>Click Me</button>

    <script>
function block(ms) {
    const start = performance.now();
    while (performance.now() - start < ms) {
        // Busy wait
    }
}

document.querySelector('button').addEventListener('click', async () => {
    block(51);
    await fetch('index.html');
    block(51);
    await scheduler.yield();
    block(51);
    await new Promise(resolve => setTimeout(resolve, 100));
    block(51);

    // Update the URL
    history.pushState({}, '', `?rand=${Math.random().toString(36).substring(2, 15)}`);

    // Add some text to the document body
    const text = "Lorem Ipsum";
    const t = document.createTextNode(text);
    const d = document.createElement('div');
    d.appendChild(t);
    document.body.appendChild(d);
});
    </script>

    <script>

// Collect these...
const eventTimings = [];
function getEventTimingForSoftNavEntry(navEntry) {
    const eventTimingEntry = eventTimings.find(event =>
        event.processingStart <= navEntry.startTime && event.processingEnd >= navEntry.startTime
    );
    return eventTimingEntry;
}

function getSoftNavEntryForICPEntry(icpEntry) {
    const navEntry = performance.getEntriesByType('soft-navigation')
        .find(nav => nav.navigationId === icpEntry.navigationId);
    return navEntry;
}

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        if (entry.interactionId) {
            eventTimings.push(entry);
            performance.measure('InteractionToNextPaint',
            {
                start: entry.startTime,
                duration: entry.duration,
                detail: {
                    devtools: {
                        dataType: "track-entry",
                        track: "INP",
                        trackGroup: "SoftNavs", // Group related tracks together
                    }
                }
            });
        }
    }
}).observe({ type: 'event', durationThreshold: 0 });

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        performance.measure('LoAF', {
            start: entry.startTime,
            duration: entry.duration,
                detail: {
                    devtools: {
                        dataType: "track-entry",
                        track: "LoAF",
                        trackGroup: "SoftNavs", // Group related tracks together
                    }
                }
        });
    }
}).observe({ type: 'long-animation-frame' });

new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        performance.measure('SoftNav', {
            start: entry.startTime,
            duration: entry.duration,
                detail: {
                    devtools: {
                        dataType: "track-entry",
                        track: "SoftNav",
                        trackGroup: "SoftNavs", // Group related tracks together
                    }
                }
        });
    }a
}).observe({ type: 'soft-navigation' });


new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        const navEntry = getSoftNavEntryForICPEntry(entry);
        const eventTimingEntry = getEventTimingForSoftNavEntry(navEntry);

        performance.measure('Soft.LCP', {
            start: navEntry.startTime,
            end: entry.startTime,
            detail: {
                devtools: {
                    dataType: "track-entry",
                    track: "Soft.ICP",
                    trackGroup: "SoftNavs", // Group related tracks together
                }
            }
        });
        
        if (eventTimingEntry) {
            performance.measure('InteractionToContentfulPaint', {
                start: eventTimingEntry.startTime,
                end: entry.startTime,
                detail: {
                    devtools: {
                        dataType: "track-entry",
                        track: "ICP",
                        trackGroup: "SoftNavs", // Group related tracks together
                    }
                }
            });
        }
    }
}).observe({ type: 'interaction-contentful-paint' });

    </script>
</body>
</html>
